#!/bin/bash
set -e -o pipefail

export PATH=$(readlink -nf /var/vcap/packages/jq):/usr/local/bin:/var/vcap/packages/aliyuncli/bin/:${PATH}

slb_id=<%= p('load_balancer_id') %>
region=<%= p('ecs_region') %>

echo "fetching instance ID"
instance_id=$(curl http://100.100.100.200/latest/meta-data/instance-id)
echo "instance id: $instance_id"

echo "checking if our instance is registered with $slb_id"
#aliyuncli --region $region slb describe-load-balancers --load-balancer-id $slb_id | jq --arg instance_id $instance_id -e '.LoadBalancerDescriptions[0].Instances[] | select(.InstanceId == $instance_id)'
check_slb_bind_ecs.py --slb_id=$slb_id --ecs_id=$instance_id